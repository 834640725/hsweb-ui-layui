<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta http-equiv=Content-Type content="text/html;charset=utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>数据列表</title>
    <link rel="stylesheet" href="../../plugins/layui/css/layui.css" media="all">
    <link rel="stylesheet" href="../../plugins/jquery-ui/jquery-ui.min.css" media="all">
    <link rel="stylesheet" href="dataList.css" />
</head>
<body class="layui-layout-body">

<div class="layui-tab">
    <ul class="layui-tab-title">
        <li class="layui-this">基本配置</li>
        <li>列表配置</li>
        <li>操作按钮配置</li>
        <li>自定义脚本</li>
    </ul>
    <div class="layui-tab-content">
        <div class="layui-tab-item layui-show">内容1</div>
        <div class="layui-tab-item">
            <table lay-data="{id:'dataListColumnsTable'}" class="layui-table" lay-filter="dataListColumnsTable">
                <thead>
                    <tr>
                        <th lay-data="{field:'field',edit:true}">字段</th>
                        <th lay-data="{field:'displayField',edit:true}">显示字段</th>
                        <th lay-data="{field:'header',edit:true}">标题</th>
                        <th lay-data="{field:'width',edit:true}">宽度</th>
                        <th lay-data="{field:'condition',event:'editCondition',templet:'#empty'}">显示条件</th>
                        <th lay-data="{field:'renderer',event:'editRenderer',templet:'#empty'}">自定义渲染</th>
                        <th lay-data="{toolbar:'#optool'}">操作</th>
                    </tr>
                </thead>
            </table>
            <div class="columns-btn-panel">
                <button class="layui-btn layui-btn-normal" lay-event="addColumns"><i class="layui-icon">&#xe654;</i>添加</button>
            </div>
        </div>
        <div class="layui-tab-item">
            <table lay-data="{id:'dataListBtnsTable'}" class="layui-table" lay-filter="dataListBtnsTable">
                <thead>
                <tr>
                    <th lay-data="{field:'icon',edit:true}">图标</th>
                    <th lay-data="{field:'text',edit:true}">标题</th>
                    <th lay-data="{field:'condition',event:'editCondition',templet:'#empty'}">显示条件</th>
                    <th lay-data="{field:'onclick',event:'editOnclick',templet:'#empty'}">点击事件</th>
                    <th lay-data="{toolbar:'#optool'}">操作</th>
                </tr>
                </thead>
            </table>
            <div class="columns-btn-panel">
                <button class="layui-btn layui-btn-normal" lay-event="addBtns"><i class="layui-icon">&#xe654;</i>添加</button>
            </div>
        </div>
        <div class="layui-tab-item">
            <textarea name="script" class="layui-textarea script-text"></textarea>
        </div>
    </div>
</div>

</body>
</html>
<script src="../../plugins/layui/layui.all.js"></script>
<script src="../../plugins/jquery-ui/jquery.js"></script>
<script src="../../plugins/jquery-ui/jquery-ui.js"></script>
<script type="text/html" id="empty">
    <span style="display: none">{{# JSON.stringify(d)}}</span>
</script>
<script type="text/html" id="optool">
    <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">
        <i class="layui-icon">&#xe640;</i>
    </button>
</script>
<script type="text/javascript">

    //列表配置JS对象
    var ListOption = function (table) {

        this.state = {
            columns:[],
            btns:[],
        }

        this.loadConfig = function (config) {
            if(config){
                if(config.columns) {
                    if(config.columns){
                        this.state.columns = config.columns
                        for(var i = 0; i < this.state.columns.length; i++){
                            this.state.columns[i].code = new Date().getTime()
                        }
                        this.reloadColumnsTable()
                    }

                    if(config.btns){
                        this.state.btns = config.btns
                        for(var i = 0; i < this.state.btns.length; i++){
                            this.state.btns[i].code = new Date().getTime()
                        }
                        this.reloadBtnsTable()
                    }

                }
            }
        }

        this.getConfig = function () {
            return {
                script: this.getConfig(),
                table: {
                    actions: this.getBtns(),
                    columns: this.getColumns(),
                }

            }
        }

        /*获取自定义脚本*/
        this.getScript = function () {
            return $('[name="script"]').val()
        }

        //---------列表配置------开始-------
        /*添加列*/
        this.addColumnsLine = function(line){
            for (var i = 0; i < this.state.columns.length;i++){
                if(line.field == this.state.columns[i].field){
                    return false
                }
            }
            line.code = new Date().getTime()
            this.state.columns.push(line)
            this.reloadColumnsTable()
        }
        /*删除列*/
        this.deleteColumnsLine = function (code) {
            var tmp = []
            for (var i = 0; i < this.state.columns.length;i++){
                if(code != this.state.columns[i].code){
                    tmp.push(this.state.columns[i])
                }
            }
            this.state.columns = tmp
            this.reloadColumnsTable()
        }
        /*更新列*/
        this.updateColumnsLine = function (line) {
            for(var i = 0; i < this.state.columns.length; i++){
                if(this.state.columns[i].code == line.code){
                    this.state.columns[i] = line
                    break
                }
            }
            this.reloadColumnsTable()
        }
        /*重新加载列表表格*/
        this.reloadColumnsTable = function(){
            table.reload('dataListColumnsTable',{
                data:this.state.columns
            })
        }
        /*获取列表数据*/
        this.getColumns = function () {
            var tmp = []
            for (var i = 0; i < this.state.columns.length;i++){
                tmp[i] = this.state.columns[i]
                var _line = {}
                for (var name in tmp[i]){
                    if(name != 'code'){
                        _line[name] = tmp[i][name]
                    }
                }
                tmp[i] = _line
            }
            return tmp
        }
        //---------列表配置------结束-------
        

        //--------按钮配置-------开始----------
        /*添加按钮*/
        this.addBtns = function (line) {
            for (var i = 0; i < this.state.btns.length;i++){
                if(line.text == this.state.btns[i].text){
                    return false
                }
            }
            line.code = new Date().getTime()
            this.state.btns.push(line)
            this.reloadBtnsTable()
        }
        /*删除按钮*/
        this.deleteBtnsLine = function (code) {
            var tmp = []
            for (var i = 0; i < this.state.btns.length;i++){
                if(code != this.state.btns[i].code){
                    tmp.push(this.state.btns[i])
                }
            }
            this.state.btns = tmp
            this.reloadBtnsTable()
        }
        /*更新按钮*/
        this.updateBtnsLine = function (line) {
            for(var i = 0; i < this.state.btns.length; i++){
                if(this.state.btns[i].code == line.code){
                    this.state.btns[i] = line
                    break
                }
            }
            this.reloadBtnsTable()
        }
        /*重新加载按钮表格*/
        this.reloadBtnsTable = function () {
            table.reload('dataListBtnsTable',{
                data:this.state.btns
            })
        }
        /*获取按钮*/
        this.getBtns = function () {
            var tmp = []
            for (var i = 0; i < this.state.btns.length;i++){
                tmp[i] = this.state.btns[i]
                var _line = {}
                for (var name in tmp[i]){
                    if(name != 'code'){
                        _line[name] = tmp[i][name]
                    }
                }
                tmp[i] = _line
            }
            return tmp
        }
        //--------按钮配置-------结束----------
    };

    var list;

    layui.use(['table'], function(table){

        list = new ListOption(table)

        var columnsEventOption = {
            delete: function (e) {
                list.deleteColumnsLine(e.data.code)
            },
            add: function (e) {
                list.addColumnsLine({field:''})
            },
            edit:function (e) {
                list.updateColumnsLine(e.data)
            },
            editCondition:function (e) {
                layer.prompt({
                    formType: 2,
                    value: e.data.condition,
                    title: '编辑显示条件',
                    area: ['800px', '350px']
                }, function(value, index, elem){
                    e.data.condition = value
                    list.updateColumnsLine(e.data)
                    layer.close(index);
                });
            },
            editRenderer:function (e) {
                layer.prompt({
                    formType: 2,
                    value: e.data.renderer,
                    title: '编辑自定义渲染',
                    area: ['800px', '350px']
                }, function(value, index, elem){
                    e.data.renderer = value
                    list.updateColumnsLine(e.data)
                    layer.close(index);
                });
            }
        }

        table.on('tool(dataListColumnsTable)',function (e) {
            columnsEventOption[e.event](e)
        })
        table.on('edit(dataListColumnsTable)',function (e) {
            columnsEventOption['edit'](e)
        })
        $('[lay-event="addColumns"]').click(function () {
            columnsEventOption['add'](this)
        })

        var btnsEventOption = {
            delete: function (e) {
                list.deleteBtnsLine(e.data.code)
            },
            add: function () {
                list.addBtns({text:''})
            },
            edit: function (e) {
                list.updateBtnsLine(e.data)
            },
            editCondition:function (e) {
                layer.prompt({
                    formType: 2,
                    value: e.data.condition,
                    title: '编辑显示条件',
                    area: ['800px', '350px']
                }, function(value, index, elem){
                    e.data.condition = value
                    list.updateBtnsLine(e.data)
                    layer.close(index);
                });
            },
            editOnclick:function (e) {
                layer.prompt({
                    formType: 2,
                    value: e.data.onclick,
                    title: '编辑点击事件',
                    area: ['800px', '350px']
                }, function(value, index, elem){
                    e.data.onclick = value
                    list.updateBtnsLine(e.data)
                    layer.close(index);
                });
            }
        }

        table.on('tool(dataListBtnsTable)',function (e) {
            btnsEventOption[e.event](e)
        })
        table.on('edit(dataListBtnsTable)',function (e) {
            btnsEventOption['edit'](e)
        })
        $('[lay-event="addBtns"]').click(function () {
            btnsEventOption['add'](this)
        })

        window.setTimeout(function () {
            if(window.ready){
                window.ready(list)
            }
        },100)


        /**
         {
	"toolbar": [{
		"id": "button_216580",
		"type": "button",
		"text": "新建按钮",
		"autz": "has('user')",
		"iconCls": "icon-group-gear",
		"onclick": "//点击按钮时执行js\nalert(1)"
	}],
	"script": "this.on('beforeQuery',function(){\n\t//this.query.like('name','%测试%').or().is('status',1)\n});",
	"condition": [{
		"text": "名称",
		"id": "cond_66909",
		"editor": {
			"type": "textbox",
			"emptyText": "输入名称",
			"format": ""
		},
		"size": 3,
		"autz": "has('user')",
		"field": "name",
		"termType": "like"
	}],
	"table": {
		"columns": [{
			"show": true,
			"_pid": -1,
			"_id": 1,
			"_uid": 1,
			"_level": 0,
			"_state": "added",
			"field": "name",
			"displayField": "name",
			"header": "名称",
			"width": "200",
			"condition": "if(1 == 1) alert(1)",
			"renderer": "alert(111111)"
		}],
		"actions": [{
			"_pid": -1,
			"_id": 2,
			"_uid": 2,
			"_level": 0,
			"_state": "added",
			"icon": "icon-cup-edit",
			"text": "操作",
			"condition": "btn-show",
			"onclick": "click-btn"
		}],
		"url": "/test/form"
	}
}
         */

    });
</script>